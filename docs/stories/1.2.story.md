# Story 1.2 – View normalized quantities

## Status

Draft

## Story

**As a** pharmacist  
**I want** to see stock in both main unit and pieces  
**So that** I quickly understand true availability.

[Source: docs/prd/epic-inventory.md#epic-1--product--multi-unit-model-box--pad--piece]

## Acceptance Criteria

1. Product list shows:
   - Quantity in main unit (e.g. box or pad).
   - Equivalent pieces.
2. All calculations use the same conversion rules as defined in Story 1.1.

[Source: docs/prd/epic-inventory.md#epic-1--product--multi-unit-model-box--pad--piece]

## Tasks / Subtasks

- [ ] Confirm dependencies from Story 1.1 (AC: 2)
  - [ ] Identify where conversion factors and product unit definitions from Story 1.1 are stored (Appwrite collections and/or utilities).
  - [ ] Confirm the canonical base unit used for normalization (for example, pieces) and how total stock per product is represented in the current data model.
  - [ ] Capture any important findings in Dev Agent Record → Completion Notes for future stories.

  [Source: docs/stories/1.1.story.md]

- [ ] Implement backend/query logic for normalized quantities (AC: 1, 2)
  - [ ] Implement or extend an Appwrite function or backend utility that returns, for each product in the list:
    - Product identity (name, code, main unit).
    - Current quantity in the main unit.
    - Equivalent quantity in pieces, calculated using the conversion rules from Story 1.1.
  - [ ] Ensure the normalized quantity calculation reuses the same conversion utilities and factors as Story 1.1 (no duplicate or divergent logic).
  - [ ] Define how to handle products that do not use all units (for example, Box→Piece only) in a way that is consistent with Story 1.1 assumptions.

  [Source: docs/brief.md#proposed-solution]

- [ ] Implement product list UI with normalized quantities (AC: 1)
  - [ ] Extend or create the product list view to display, for each product:
    - Quantity in the main unit.
    - Equivalent quantity in pieces.
  - [ ] Ensure the layout and labels make it obvious to the pharmacist which value is which, optimizing for quick comprehension.
  - [ ] Reuse existing UI components and styling conventions defined for the pharmacy system frontend.

  [Source: docs/brief.md#target-users]

- [ ] Ensure consistency with future inventory overview (AC: 1, 2)
  - [ ] Design the normalized quantity display so it can be reused or extended for the future Inventory overview page (Epic 5.1).
  - [ ] Avoid UI or data patterns that will conflict with planned inventory visibility and search stories.

  [Source: docs/prd/epic-inventory.md#epic-5--inventory-visibility--search]

- [ ] Testing tasks (AC: 1, 2)
  - [ ] Add unit tests for the normalized quantity calculation logic, verifying that values in main unit and pieces match expectations for a variety of conversion configurations.
  - [ ] Add integration tests for the product list endpoint or function to confirm it returns both main-unit and pieces values.
  - [ ] Add UI tests (where applicable) to verify that the product list displays both quantities correctly and updates when underlying stock changes.

  [Source: docs/brief.md#technical-considerations]

## Dev Notes

### Previous Story Insights

- This story depends on Story 1.1 – the data model and conversion utilities implemented there are the single source of truth for unit conversions.
- Any change to conversion logic in Story 1.1 must be reflected here; do not re-implement or fork conversion logic in this story.
  [Source: docs/stories/1.1.story.md]

### Data Models

- Architecture docs referenced in `.bmad-core/core-config.yaml` (for example, `docs/architecture/...`) are still not present in the repository at the time of drafting. No formal architecture specification for product or inventory aggregation is available yet.
  [Source: .bmad-core/core-config.yaml]
- From the Project Brief, the system uses Appwrite Databases/TablesDB for products, units, batches, movements, thresholds, and users.
  [Source: docs/brief.md#technical-considerations]
- For this story, the developer should:
  - Reuse the product and unit conversion data model defined in Story 1.1.
  - Use the current source of truth for per-product stock totals (for example, a derived field, or aggregation over movement records, depending on how the system has been implemented so far).
- Any additional schema decisions needed for exposing normalized quantities (such as precomputed totals vs on-the-fly calculation) should be documented in the Dev Agent Record and later migrated into architecture docs once available.

### Assumptions & Edge Cases

- All conversion factors remain positive integers, consistent with Story 1.1.
- Products may use only some of the units (for example, Box→Piece); normalized quantity calculations must handle missing intermediate units predictably.
- If stock totals are derived from movement records, ensure that small rounding or aggregation discrepancies do not create inconsistent main-unit vs pieces displays.
- Assumptions should be revisited and aligned with formal domain and architecture documentation when it becomes available.

### API Specifications

- There is still no dedicated backend/API specification under `docs/architecture`.
  [Source: .bmad-core/core-config.yaml]
- Any endpoint or function used to power the product list with normalized quantities should:
  - Use Appwrite as the BaaS layer.
    [Source: docs/brief.md#technical-considerations]
  - Reuse conversion utilities from Story 1.1.
  - Avoid exposing internal implementation details of how totals are stored or aggregated.
- Document any new or updated endpoints and payloads (including normalized quantities fields) in the Dev Agent Record and, once available, in architecture docs.

### Component Specifications

- UI component and frontend architecture documents are not yet available in `docs/architecture`.
- For this story, follow the existing frontend stack (React SPA with Vite, TypeScript, Tailwind CSS, React Router) and the project’s UI component library.
  [Source: docs/brief.md#technology-preferences]
- The product list UI for normalized quantities should be designed so it can be extended or integrated into the future Inventory overview page from Epic 5.1.

### File Locations

- `.bmad-core/core-config.yaml` references `docs/architecture/unified-project-structure.md`, but neither that file nor the `docs/architecture` directory currently exists.
  [Source: .bmad-core/core-config.yaml]
- Until a unified project structure document exists, follow existing frontend and Appwrite functions directory conventions and document all created/modified files in the Dev Agent Record → File List.

### Testing Requirements

- There is no `testing-strategy.md` architecture document yet; test locations and patterns are not formally defined.
  [Source: .bmad-core/core-config.yaml]
- For this story:
  - Add unit tests for the normalized quantity calculations.
  - Add integration tests verifying that the product list data includes both main-unit and pieces quantities.
  - Add UI tests for correct rendering and updates of normalized quantities in the list.

### Technical Constraints

- Frontend remains a React SPA with Vite, TypeScript, Tailwind CSS, and React Router.
  [Source: docs/brief.md#technology-preferences]
- Backend relies on Appwrite for auth, database, functions, and storage.
  [Source: docs/brief.md#technology-preferences]
- Performance expectations still apply: inventory views must perform well for thousands of SKUs and tens of thousands of movements.
  [Source: docs/brief.md#platform-requirements]

### Project Structure Notes

- The mismatch between `.bmad-core/core-config.yaml` expectations and the current lack of `docs/architecture` persists.
- Once architecture docs and a unified project structure guide are added, revisit this story to:
  - Add concrete file paths and component locations for the product list.
  - Align normalized quantity display and data access patterns with the standardized architecture.

## Testing

- **Approach**
  - Unit tests for normalized quantity calculation utilities.
  - Integration tests for the data access layer or endpoint powering the product list.
  - UI tests to validate correct display and updates of normalized quantities.
- **Key Scenarios**
  - Product with simple Box↔Piece configuration shows correct main-unit and pieces quantities in the list. (AC: 1, 2)
  - Product with intermediate Pad unit (Box→Pad→Piece) still displays correct normalized quantities. (AC: 1, 2)
  - All calculations use the same conversion logic as Story 1.1; any change in 1.1 conversion factors is reflected in this view without additional changes. (AC: 2)
- **Success Criteria**
  - All tests associated with this story pass in CI.
  - Manual smoke test confirms that quantities displayed in the product list match expectations for configured products and conversion factors.

## Change Log

| Date       | Version | Description                        | Author |
| ---------- | ------- | ---------------------------------- | ------ |
| YYYY-MM-DD | 0.1     | Initial draft of Story 1.2        | Scrum Master |

## Dev Agent Record

### Agent Model Used

_TBD by dev agent._

### Debug Log References

_TBD by dev agent._

### Completion Notes List

_TBD by dev agent._

### File List

_TBD by dev agent._

## QA Results

_TBD by QA agent once implementation is complete._
